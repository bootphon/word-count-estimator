import yaml
import pkg_resources
from librosa import load
from librosa.feature import mfcc
import numpy as np


class DataProcessing():
    """
    Class for data processing tasks.

    Attributes
    ----------

    Methods
    -------
    save_parameters(params_file)
        Save the data processing parameters to a given file.
    load_parameters(params_file)
        Load the data processing parameters from a given file.
    generate_features(audio_file)
        Generate the MFCC sequence of an audio file.
    """

    def __init__(self, sample_rate=16000, window_length=0.025,
                 window_step=0.01, fmin=0.0, fmax=None, n_mels=24,
                 coefs=23, enhancement=False, use_meme_devi=True):
        """
        Parameters
        ----------
        sample_rate :
        window_length : float
            Length of the sliding window for the features generation as a fraction
            of the audio files sample rate.
            Defaults to 0.025.
        window_step : float
            Step of the sliding window for the features generation as a fraction
            of the audio files sample rate.
            Defaults to 0.01.
        fmin :
        fmax : 
        n_mels :
        coefs :
        enhancement :
        use_meme_devi :
        """

        self.sample_rate = sample_rate
        self.window_length = window_length
        self.window_step = window_step
        self.fmin = fmin
        self.fmax = fmax
        self.n_mels = n_mels
        self.coefs = coefs
        self.enhancement = enhancement
        self.use_meme_devi = use_meme_devi

    def save_parameters(self, params_file):
        """
        Save the data processing parameters to a file.

        Parameters
        ----------
        params_file : str
            Path to the file to store the parameters.
        """

        try:
            with open(params_file) as f:
                params = yaml.load(f)
        except IOError:
            print("Wrong parameters file.")

        params['data_processing'] = self.__dict__

        with open(params_file, 'w') as f:
            yaml.dump(params, f)

    def load_parameters(self, params_file):
        """
        Load the data processing parameters from a file.

        Parameters
        ----------
        params_file : str
            Path to the file where the parameters are stored.
        """

        try:
            with open(params_file) as f:
                params = yaml.load(f)
        except IOError:
            print("Wrong parameters file.")

        for attr in params['data_processing']:
            setattr(self, attr, params[attr])

    def generate_features(self, audio_file):
        """
        Generate the MFCC sequence of an audio file.

        Parameters
        ----------
        audio_file : str
            Path to the audio file to process.

        Returns
        -------
        features : ndarray
            2D, matrix of features: MFCC sequence.
        """

        wav, sr = load(audio_file, self.sample_rate)

        # TODO: add speech enhancement
        if self.enhancement:
            pass

        n_mfcc = self.coefs + 1
        n_fft = int(self.window_length * sr)
        hop_length = int(self.window_step * sr)

        features = mfcc(y=wav, sr=sr, n_mfcc=n_mfcc,
                        n_fft=n_fft, hop_length=hop_length,
                        n_mels=self.n_mels, htk=True,
                        fmin=self.fmin, fmax=self.fmax)

        features = np.swapaxes(features, 0, 1)

        if self.use_meme_devi:
            path_meme = "matrices/meme.npy"
            path_meme = "matrices/meme.npy"
            module_name = 'wce.envelope_estimation.processing'
            meme_f = pkg_resources.resource_stream(module_name, path_meme).read()
            devi_f = pkg_resources.resource_stream(module_name, path_meme).read()
            meme = np.frombuffer(meme_f)
            devi = np.frombuffer(devi_f)
            features = features - meme
            features = features / devi
            #except:
           #     print("Problem with matrices files meme and devi.")

        return features

